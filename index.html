
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DebtManager Pro | Gestão de Dívidas</title>
    
    <!-- Scripts Base -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "mysql2/": "https://esm.sh/mysql2@^3.16.0/",
    "@google/genai": "https://esm.sh/@google/genai@^1.36.0"
  }
}
</script>
    
    <style>
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: #f8fafc; margin: 0; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root">
        <!-- Loader inicial caso o JS demore -->
        <div class="flex items-center justify-center h-screen bg-slate-50">
            <div class="text-center">
                <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-slate-500 font-medium">Carregando Sistema...</p>
            </div>
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Users, Plus, Search, Edit3, LayoutDashboard, 
          X, Phone, Mail, DollarSign, Wallet, AlertCircle
        } from 'lucide-react';

        // Tenta usar a URL do ambiente ou fallback para localhost
        const API_BASE = window.location.hostname === 'localhost' 
          ? 'http://localhost:3001' 
          : 'https://clientesresgistro.onrender.com';

        const App = () => {
          const [customers, setCustomers] = useState([]);
          const [loading, setLoading] = useState(true);
          const [view, setView] = useState('dashboard');
          const [searchTerm, setSearchTerm] = useState('');
          const [modalOpen, setModalOpen] = useState(false);
          const [selectedCustomer, setSelectedCustomer] = useState(null);
          const [formData, setFormData] = useState({ name: '', email: '', phone: '', totalDebt: '' });

          const fetchCustomers = async () => {
            setLoading(true);
            try {
              const res = await fetch(`${API_BASE}/customers`);
              const data = await res.json();
              setCustomers(Array.isArray(data) ? data : []);
            } catch (err) {
              console.error("Erro API:", err);
            } finally {
              setLoading(false);
            }
          };

          useEffect(() => { fetchCustomers(); }, []);

          const stats = useMemo(() => {
            const total = customers.reduce((acc, c) => acc + Number(c.totalDebt || 0), 0);
            return { total, count: customers.length };
          }, [customers]);

          const filtered = customers.filter(c => 
            c.name?.toLowerCase().includes(searchTerm.toLowerCase())
          );

          const openModal = (customer = null) => {
            if (customer) {
              setSelectedCustomer(customer);
              setFormData({ 
                name: customer.name, 
                email: customer.email, 
                phone: customer.phone, 
                totalDebt: customer.totalDebt 
              });
            } else {
              setSelectedCustomer(null);
              setFormData({ name: '', email: '', phone: '', totalDebt: '' });
            }
            setModalOpen(true);
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            const method = selectedCustomer ? 'PUT' : 'POST';
            const url = selectedCustomer 
              ? `${API_BASE}/customers/${selectedCustomer.id}` 
              : `${API_BASE}/customers`;
            
            const payload = selectedCustomer 
              ? { ...formData } 
              : { ...formData, id: crypto.randomUUID() };

            try {
              const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              if (res.ok) {
                setModalOpen(false);
                fetchCustomers();
              }
            } catch (err) {
              alert("Erro ao salvar. Verifique se o servidor está rodando.");
            }
          };

          return (
            <div className="flex min-h-screen bg-slate-50">
              {/* Sidebar */}
              <nav className="w-64 bg-slate-900 text-white p-6 flex flex-col gap-8 hidden md:flex">
                <div className="flex items-center gap-3 px-2">
                  <div className="bg-indigo-500 p-2 rounded-xl text-white">
                    <Wallet size={24}/>
                  </div>
                  <span className="text-xl font-bold tracking-tight">DebtPro</span>
                </div>
                
                <div className="space-y-1">
                  <button 
                    onClick={() => setView('dashboard')}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'dashboard' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}
                  >
                    <LayoutDashboard size={18}/> Dashboard
                  </button>
                  <button 
                    onClick={() => setView('customers')}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'customers' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}
                  >
                    <Users size={18}/> Clientes
                  </button>
                </div>
              </nav>

              {/* Conteúdo Principal */}
              <div className="flex-1 flex flex-col">
                <header className="h-20 bg-white border-b border-slate-200 px-8 flex items-center justify-between sticky top-0 z-10">
                  <div className="relative w-72">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16}/>
                    <input 
                      placeholder="Pesquisar..."
                      className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-sm"
                      value={searchTerm}
                      onChange={e => setSearchTerm(e.target.value)}
                    />
                  </div>
                  <button 
                    onClick={() => openModal()}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-indigo-100 text-sm"
                  >
                    <Plus size={18}/> Novo Cliente
                  </button>
                </header>

                <main className="p-8 animate-fade-in overflow-y-auto">
                  {view === 'dashboard' ? (
                    <div className="space-y-8">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                          <p className="text-slate-400 text-xs font-bold uppercase tracking-widest">Total em Aberto</p>
                          <h2 className="text-3xl font-black text-slate-800 mt-2">
                            R$ {stats.total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                          </h2>
                        </div>
                        <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                          <p className="text-slate-400 text-xs font-bold uppercase tracking-widest">Clientes Registrados</p>
                          <h2 className="text-3xl font-black text-slate-800 mt-2">{stats.count}</h2>
                        </div>
                      </div>

                      <div className="bg-white rounded-3xl border border-slate-100 shadow-sm p-6">
                        <h3 className="font-bold text-slate-800 mb-4">Devedores Recentes</h3>
                        {loading ? (
                          <div className="py-10 text-center text-slate-400">Carregando dados...</div>
                        ) : (
                          <div className="space-y-3">
                            {customers.slice(0, 5).map(c => (
                              <div key={c.id} className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                <div>
                                  <p className="font-bold text-slate-700">{c.name}</p>
                                  <p className="text-xs text-slate-400">{c.email}</p>
                                </div>
                                <span className="font-black text-rose-600">R$ {Number(c.totalDebt).toFixed(2)}</span>
                              </div>
                            ))}
                            {customers.length === 0 && <p className="text-center py-4 text-slate-400">Nenhum registro.</p>}
                          </div>
                        )}
                      </div>
                    </div>
                  ) : (
                    <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                      <table className="w-full text-left">
                        <thead className="bg-slate-50 text-slate-400 text-[10px] font-bold uppercase tracking-widest">
                          <tr>
                            <th className="px-6 py-4">Cliente</th>
                            <th className="px-6 py-4">Contato</th>
                            <th className="px-6 py-4 text-right">Dívida</th>
                            <th className="px-6 py-4 text-center">Ações</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {filtered.map(c => (
                            <tr key={c.id} className="hover:bg-slate-50/50 transition-colors">
                              <td className="px-6 py-4">
                                <div className="font-bold text-slate-700">{c.name}</div>
                              </td>
                              <td className="px-6 py-4">
                                <div className="text-xs text-slate-500">{c.email}</div>
                                <div className="text-[10px] text-slate-400">{c.phone}</div>
                              </td>
                              <td className="px-6 py-4 text-right font-black text-rose-600">
                                R$ {Number(c.totalDebt).toFixed(2)}
                              </td>
                              <td className="px-6 py-4 text-center">
                                <button 
                                  onClick={() => openModal(c)}
                                  className="p-2 text-slate-400 hover:text-indigo-600 rounded-lg hover:bg-indigo-50 transition-all"
                                >
                                  <Edit3 size={16}/>
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </main>
              </div>

              {/* Modal de Formulário */}
              {modalOpen && (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                  <div className="bg-white w-full max-w-md rounded-[2rem] p-8 shadow-2xl animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                      <h2 className="text-xl font-black text-slate-800">
                        {selectedCustomer ? 'Editar Cliente' : 'Novo Cadastro'}
                      </h2>
                      <button onClick={() => setModalOpen(false)} className="text-slate-400 hover:text-slate-600">
                        <X size={20}/>
                      </button>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-4">
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Nome</label>
                        <input 
                          required
                          className="w-full p-3.5 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                          value={formData.name}
                          onChange={e => setFormData({...formData, name: e.target.value})}
                        />
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Telefone</label>
                          <input 
                            className="w-full p-3.5 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                            value={formData.phone}
                            onChange={e => setFormData({...formData, phone: e.target.value})}
                          />
                        </div>
                        <div>
                          <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Dívida (R$)</label>
                          <input 
                            type="number" step="0.01"
                            className="w-full p-3.5 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all font-bold text-rose-600"
                            value={formData.totalDebt}
                            onChange={e => setFormData({...formData, totalDebt: e.target.value})}
                          />
                        </div>
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Email</label>
                        <input 
                          type="email"
                          className="w-full p-3.5 bg-slate-50 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                          value={formData.email}
                          onChange={e => setFormData({...formData, email: e.target.value})}
                        />
                      </div>

                      <button 
                        type="submit"
                        className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-100 transition-all mt-4"
                      >
                        {selectedCustomer ? 'Salvar Alterações' : 'Criar Registro'}
                      </button>
                    </form>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
